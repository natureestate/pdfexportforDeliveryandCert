rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================
    // ฟังก์ชันพื้นฐาน (Basic Functions)
    // ============================================================
    
    // ตรวจสอบว่าผู้ใช้ Login แล้วหรือยัง
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ตรวจสอบว่าเป็นเจ้าของเอกสารหรือไม่
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ตรวจสอบว่าเป็น Super Admin หรือไม่
    // หมายเหตุ: Super Admin ต้องมี document ใน superAdmins collection โดยใช้ userId เป็น document ID
    function isSuperAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/superAdmins/$(request.auth.uid));
    }
    
    // ============================================================
    // ฟังก์ชันตรวจสอบสมาชิกขององค์กร (Company Membership Functions)
    // ============================================================
    
    // ตรวจสอบว่าเป็นสมาชิกขององค์กรหรือไม่ (Active members only)
    // รูปแบบ document ID: {userId}_{companyId}
    function isMemberOfCompany(companyId) {
      let memberDoc = get(/databases/$(database)/documents/companyMembers/$(request.auth.uid + '_' + companyId));
      return memberDoc != null && memberDoc.data.status == 'active';
    }
    
    // ตรวจสอบว่าเป็น Admin ขององค์กรหรือไม่
    function isAdminOfCompany(companyId) {
      let memberDoc = get(/databases/$(database)/documents/companyMembers/$(request.auth.uid + '_' + companyId));
      return memberDoc != null && memberDoc.data.status == 'active' && memberDoc.data.role == 'admin';
    }
    
    // ตรวจสอบว่าเป็นเจ้าของบริษัท (คนที่สร้างบริษัท)
    function isCompanyOwner(companyId) {
      let companyDoc = get(/databases/$(database)/documents/companies/$(companyId));
      return companyDoc != null && companyDoc.data.userId == request.auth.uid;
    }
    
    // ============================================================
    // ฟังก์ชันตรวจสอบสิทธิ์เอกสาร (Document Access Functions)
    // ============================================================
    
    // ตรวจสอบว่าสามารถเข้าถึงเอกสารได้หรือไม่
    // - เป็นเจ้าของเอกสาร หรือ
    // - เป็นสมาชิกขององค์กรที่เอกสารนั้นสังกัด หรือ
    // - เป็น Super Admin
    function canAccessDocument() {
      return isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId));
    }
    
    // ตรวจสอบว่าสามารถแก้ไขเอกสารได้หรือไม่
    function canModifyDocument() {
      return isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId));
    }
    
    // ============================================================
    // เอกสารธุรกิจ (Business Documents)
    // ============================================================
    
    // ใบส่งมอบงาน (Delivery Notes)
    match /deliveryNotes/{documentId} {
      // อ่าน: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน หรือ Super Admin
      allow read: if isAuthenticated() && canAccessDocument();
      
      // สร้าง: ต้อง Login และ userId ต้องตรงกับผู้ใช้
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข/ลบ: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน หรือ Super Admin
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบรับประกันสินค้า (Warranty Cards)
    match /warrantyCards/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบแจ้งหนี้ (Invoices)
    match /invoices/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบเสร็จ (Receipts)
    match /receipts/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบกำกับภาษี (Tax Invoices)
    match /taxInvoices/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบเสนอราคา (Quotations)
    match /quotations/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบสั่งซื้อ (Purchase Orders)
    match /purchaseOrders/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบบันทึก (Memos)
    match /memos/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ใบส่วนต่าง (Variation Orders)
    match /variationOrders/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // สัญญาจ้างเหมาช่วง (Subcontracts)
    match /subcontracts/{documentId} {
      allow read: if isAuthenticated() && canAccessDocument();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && canModifyDocument();
    }
    
    // ============================================================
    // ข้อมูลบริษัทและโปรไฟล์ (Company & Profile Data)
    // ============================================================
    
    // Company Profiles (ข้อมูลบริษัทที่บันทึกไว้ - Legacy)
    match /companyProfiles/{profileId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Companies (ข้อมูลบริษัทสำหรับระบบ Multi-Company)
    match /companies/{companyId} {
      // อ่าน: สมาชิกบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId) ||
        isMemberOfCompany(companyId)
      );
      
      // สร้าง: ต้อง Login และ userId ต้องตรงกับผู้ใช้
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // แก้ไข: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId) ||
        isAdminOfCompany(companyId)
      );
      
      // ลบ: เจ้าของบริษัท หรือ Super Admin เท่านั้น
      allow delete: if isAuthenticated() && (isSuperAdmin() || isCompanyOwner(companyId));
    }
    
    // Company Members (สมาชิกในองค์กร)
    match /companyMembers/{memberId} {
      // อ่าน: สมาชิกบริษัทเดียวกัน หรือ Super Admin
      // memberId format: {userId}_{companyId}
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        // ตรวจสอบว่าเป็นสมาชิกของบริษัทเดียวกัน
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId)) ||
        // หรือเป็นเจ้าของ membership นี้
        resource.data.userId == request.auth.uid
      );
      
      // สร้าง: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(request.resource.data.companyId) ||
        isAdminOfCompany(request.resource.data.companyId)
      );
      
      // แก้ไข: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(resource.data.companyId) ||
        isAdminOfCompany(resource.data.companyId)
      );
      
      // ลบ: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(resource.data.companyId) ||
        isAdminOfCompany(resource.data.companyId)
      );
    }
    
    // ============================================================
    // ข้อมูลเสริม (Supporting Data)
    // ============================================================
    
    // Service Templates (Template สำหรับข้อมูลสินค้า/บริการ)
    match /serviceTemplates/{templateId} {
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Customers (ข้อมูลลูกค้า)
    match /customers/{customerId} {
      // อ่าน: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Contractors (ข้อมูลช่าง/ผู้รับจ้าง)
    match /contractors/{contractorId} {
      // อ่าน: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Document Numbers (เลขที่เอกสารอัตโนมัติ - Running Number)
    match /documentNumbers/{counterId} {
      // อ่าน: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.userId != null && isOwner(resource.data.userId)) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // สร้าง: ต้อง Login และ userId ต้องตรงกับผู้ใช้
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        (request.resource.data.companyId != null && isMemberOfCompany(request.resource.data.companyId))
      );
      
      // แก้ไข: เจ้าของ หรือ สมาชิกบริษัทเดียวกัน
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.userId != null && isOwner(resource.data.userId)) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // ไม่อนุญาตให้ลบ counter (เพื่อรักษาความสมบูรณ์ของข้อมูล)
      allow delete: if false;
    }
    
    // ============================================================
    // ระบบคำเชิญ (Invitation System)
    // ============================================================
    
    // Invitations (คำเชิญเข้าองค์กร)
    match /invitations/{invitationId} {
      // อ่าน: ผู้ถูกเชิญ หรือ Admin ของบริษัท หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        resource.data.email == request.auth.token.email ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId)) ||
        resource.data.invitedBy == request.auth.uid
      );
      
      // สร้าง: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(request.resource.data.companyId) ||
        isAdminOfCompany(request.resource.data.companyId)
      );
      
      // แก้ไข: ผู้ถูกเชิญ (เพื่อ accept/reject) หรือ Admin ของบริษัท หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        resource.data.email == request.auth.token.email ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId))
      );
      
      // ลบ: Admin ของบริษัท หรือ Super Admin
      allow delete: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId))
      );
    }
    
    // ============================================================
    // ระบบอีเมล (Email System)
    // ============================================================
    
    // Mail (สำหรับ Firebase Email Extension)
    match /mail/{mailId} {
      // สร้าง: ต้อง Login
      allow create: if isAuthenticated();
      
      // อ่าน: เฉพาะผู้ที่สร้าง (สำหรับตรวจสอบสถานะ)
      allow read: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
      
      // ไม่อนุญาตให้แก้ไขหรือลบ (Email Extension จะจัดการเอง)
      allow update, delete: if false;
    }
    
    // ============================================================
    // ระบบ Super Admin (Super Admin System) - ป้องกันอย่างเข้มงวด
    // ============================================================
    
    // Super Admins (ผู้ดูแลระดับสูงสุด)
    // ⚠️ สำคัญ: การสร้าง Super Admin ใหม่ต้องทำผ่าน Firebase Console หรือ Admin SDK เท่านั้น
    match /superAdmins/{adminId} {
      // อ่าน: เฉพาะ Super Admin หรือเจ้าของ document
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        adminId == request.auth.uid
      );
      
      // ⛔ สร้าง: ปิดการสร้างจาก Client ทั้งหมด
      // การสร้าง Super Admin ใหม่ต้องทำผ่าน:
      // 1. Firebase Console โดยตรง
      // 2. Admin SDK (Server-side)
      // 3. Cloud Functions ที่มีการตรวจสอบสิทธิ์
      allow create: if false;
      
      // แก้ไข: เฉพาะ Super Admin เท่านั้น
      allow update: if isAuthenticated() && isSuperAdmin();
      
      // ลบ: ไม่อนุญาต (ป้องกันการลบ Super Admin โดยไม่ตั้งใจ)
      allow delete: if false;
    }
    
    // ============================================================
    // ระบบโควตาและแผนการใช้งาน (Quota & Plan System)
    // ============================================================
    
    // Company Quotas (โควตาและแผนการใช้งานของบริษัท)
    match /companyQuotas/{companyId} {
      // อ่าน: สมาชิกบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isMemberOfCompany(companyId) ||
        isCompanyOwner(companyId)
      );
      
      // สร้าง: เฉพาะ Super Admin หรือเมื่อสร้างบริษัทใหม่ (เจ้าของบริษัท)
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId)
      );
      
      // แก้ไข: เฉพาะ Super Admin
      allow update: if isAuthenticated() && isSuperAdmin();
      
      // ลบ: เฉพาะ Super Admin
      allow delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // Plan Templates (Template แผนการใช้งาน)
    match /planTemplates/{planId} {
      // อ่าน: ทุกคนที่ Login (เพื่อแสดงแผนการใช้งาน)
      allow read: if isAuthenticated();
      
      // สร้าง/แก้ไข/ลบ: เฉพาะ Super Admin
      allow create, update, delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // ============================================================
    // ระบบ PDPA และ Consent (PDPA & Consent System)
    // ============================================================
    
    // User Consents (Cookie Consent และ PDPA Consent)
    match /userConsents/{consentUserId} {
      // อ่าน: เจ้าของ consent หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        consentUserId == request.auth.uid
      );
      
      // สร้าง: เจ้าของ consent (userId ต้องตรงกับ user ปัจจุบัน)
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid && 
        consentUserId == request.auth.uid;
      
      // แก้ไข: เจ้าของ consent หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        consentUserId == request.auth.uid
      );
      
      // ไม่อนุญาตให้ลบ (เพื่อรักษาประวัติการยอมรับตาม PDPA)
      allow delete: if false;
    }
    
    // ============================================================
    // ระบบตั้งค่าเมนู (Menu Settings System)
    // ============================================================
    
    // Menu Settings (การตั้งค่าเมนูของบริษัท - ตาม Role)
    // Document ID = companyId
    match /menuSettings/{companyId} {
      // อ่าน: สมาชิกบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isMemberOfCompany(companyId) ||
        isCompanyOwner(companyId)
      );
      
      // สร้าง: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId) ||
        isAdminOfCompany(companyId)
      );
      
      // แก้ไข: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId) ||
        isAdminOfCompany(companyId)
      );
      
      // ลบ: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(companyId) ||
        isAdminOfCompany(companyId)
      );
    }
    
    // User Menu Settings (การตั้งค่าเมนูรายบุคคล)
    // Document ID = {companyId}_{userId}
    match /userMenuSettings/{docId} {
      // อ่าน: เจ้าของการตั้งค่า หรือ Admin ของบริษัท หรือ Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId)) ||
        (resource.data.companyId != null && isCompanyOwner(resource.data.companyId))
      );
      
      // สร้าง: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        isCompanyOwner(request.resource.data.companyId) ||
        isAdminOfCompany(request.resource.data.companyId)
      );
      
      // แก้ไข: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow update: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.companyId != null && isCompanyOwner(resource.data.companyId)) ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId))
      );
      
      // ลบ: Admin ของบริษัท หรือ เจ้าของบริษัท หรือ Super Admin
      allow delete: if isAuthenticated() && (
        isSuperAdmin() ||
        (resource.data.companyId != null && isCompanyOwner(resource.data.companyId)) ||
        (resource.data.companyId != null && isAdminOfCompany(resource.data.companyId))
      );
    }
    
    // ============================================================
    // Default Rule - ปฏิเสธทุก collection อื่นๆ
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
